angular.module("helpme",["ionic","restangular","helpme.controllers","helpme.services","helpme.directives","helpme.filters","ngCordova","igTruncate"]).run(function(e,t,o,r){e.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&StatusBar.styleDefault(),window.plugin.notification.local.onclick=function(e,o,r){alert(JSON.parse(r).from),t.$broadcast("notification.local.click",{id:e,state:o,json:JSON.parse(r)})}}),t.$on("$stateChangeStart",function(e,t){t.data.requiresLogin&&!o.authenticated&&(e.preventDefault(),r.transitionTo("login"))})}).config(function(e,t,o,r,n){o.setBaseUrl(ENDPOINT),o.setFullResponse(!0),r.setIo(io),e.state("root",{url:"/",controller:function(e){e.transitionTo("login")},data:{requiresLogin:!1}}).state("login",{url:"/login",templateUrl:"templates/login.html",controller:"LoginCtrl",data:{requiresLogin:!1}}).state("homepage",{url:"/home","abstract":!0,controller:"HomepageCtrl",templateUrl:"templates/menu.html",data:{requiresLogin:!0}}).state("homepage.proveedores",{url:"/proveedores",views:{menuContent:{templateUrl:"templates/proveedores.html",controller:"ProveedoresCtrl"}},data:{requiresLogin:!0}}).state("homepage.mensajes",{url:"/proveedores/mensajes",views:{menuContent:{templateUrl:"templates/proveedores/mensajes.html",controller:"MensajesCtrl"}},data:{requiresLogin:!0}}).state("homepage.chat",{url:"/proveedores/chat/:id",views:{menuContent:{templateUrl:"templates/proveedores/show.html",controller:"ChatCtrl"}},data:{requiresLogin:!0}}).state("homepage.profile",{url:"/profile/:id",views:{menuContent:{templateUrl:"templates/proveedores/profile/profile.html",controller:"ProfileCtrl"}}}),t.otherwise("/"),n.interceptors.push("TokenInterceptor")}),ionic.Platform.ready(function(){window.plugin.notification.local.onclick=function(e,t,o){"com.help.upplus4.notification.message"==e&&$scope.apply(function(){$state.transitionTo("homepage.chat",{id:o.from})})}});
var controllers;controllers=angular.module("helpme.controllers",[]),controllers.controller("LoginCtrl",["$scope","$state","SessionService","$ionicPopup","LoadingService","$cordovaSms",function(e,o,t,n,s){return e.loginData={},e.showBar=!1,e.login=function(e){s.show("Comprobando credenciales..."),t.login(e,function(e){s.hide(),200==e.status?o.transitionTo("homepage.proveedores"):n.alert({title:'<i class="icon ion-alert-circled"></i>  Usuario o contraseña inválida',template:"Compruebe las credenciales"})})}}]),controllers.controller("MainCtrl",function(e,o,t,n,s,i,a,r,c,l){e.messages=[],e.messageCount=0,e.user={},e.messages=[],e.total_users=0,e.incommingMessages=[],e.users=[],e.useGPS={status:!1},e.goToMessages=function(){o.transitionTo("messages")},e.$on("notification.local.click",function(t,n){"com.help.upplus4.notification.message"==n.id&&e.apply(function(){o.transitionTo("homepage.chat",{id:n.json.from})})}),e.$on("user.messaged",function(o,n){t.add({id:"com.help.upplus4.notification.message",title:"Mensaje recibido",message:n.data.from.name+": "+n.data.type=="text"?n.data.message:"Imagen",json:{from:n.data.from.userid}}).then(function(e){console.log(e)}),e.incommingMessages.push(n)}),e.goToProfile=function(){o.transitionTo("homepage.profile",{id:n.user.id})},e.logout=function(){n.logout(),o.transitionTo("login")};({notificationTitle:"Background tracking",notificationText:"ENABLED",debug:!0,url:ENDPOINT+"/gps",params:{from:n.user.id},headers:{authorization:a.sessionStorage.token},timeout:15e3,desiredAccuracy:10,stationaryRadius:20,distanceFilter:30,stopOnTerminate:!1,enableHighAccuracy:!0});e.$watch("useGPS.status",function(e){e&&i.getCurrentPosition({enableHighAccuracy:!0,maximumAge:3e3,timeout:6e4}).then(function(e){r.emit("post","/gps/receive",{position:e,from:n.user.id})},function(e){alert(e)})}),e.$on("gps.received",function(e,o){console.log(o),c.showLongCenter("Usuario "+o.data.user+"ubicado en: "+o.data.latitude+o.data.longitude)}),e.$on("user.session.close",function(){n.logout(),l.alert({title:"Nueva sesión",template:"Se ha iniciado sesión en otra ubicación"}).then(function(){o.transitionTo("login")})})}),controllers.controller("HomepageCtrl",function(){}),controllers.controller("ProveedoresCtrl",["$scope","socket","$window","$ionicActionSheet","$state","SessionService",function(e,o,t,n,s){o.emit("get","/sessionuser/list",function(t){e.$apply(function(){e.users=o.users=t})}),e.$on("user.added",function(o,t){e.$apply(function(){e.users.push(t)})}),e.$on("user.logged_in",function(){e.$apply(function(){})}),e.$on("user.destroyed",function(){e.$apply(function(){})}),e.openSheet=function(e){n.show({buttons:[{text:'<i class="icon ion-person"></i> Ver perfil'},{text:'<i class="icon ion-chatbox"></i> Enviar mensaje'}],titleText:"Acciones",buttonClicked:function(o){1==o&&s.transitionTo("homepage.chat",{id:e}),0==o&&s.transitionTo("homepage.profile",{id:e})}})};var i=!0;e.needToLoad=function(){return o.users.length>=10&&i},e.loadMore=function(){o.emit("get","/sessionuser/list",{skip:o.users.length},function(t){0==t.length&&(i=!1),e.$apply(function(){e.users=o.users=o.users.concat(t),e.$broadcast("scroll.infiniteScrollComplete")})})}}]),controllers.controller("ChatCtrl",["$scope","$rootScope","$stateParams","socket","$cordovaLocalNotification","$window","SessionService","$ionicScrollDelegate","$ionicModal",function(e,o,t,n,s,i,a,r,c){var l=t.id;n.socket.get("/conversations/"+a.user.id+"/"+l,{headers:{Authorization:i.sessionStorage.token}},function(o){e.$apply(function(){r.$getByHandle("chat").scrollBottom(),e.messages=o})}),n.socket.get("/sessionuser/"+l,function(o){e.user=o}),e.send=function(o,t){e.newMessage="",e.messages.push({id:-1,type:t,message:o,createdAt:new Date,from:a.user.user,sent:!1,received:!1}),n.socket.post("/sessionuser/message/",{to:l,message:o,type:t},function(o){e.$apply(function(){var t=_.findIndex(e.messages,{id:-1});e.messages[t]=o,r.$getByHandle("chat").scrollBottom()})})},e.$on("user.messaged",function(o,t){t.data.from.userid==l?(e.$apply(function(){e.messages.push(t.data),r.$getByHandle("chat").scrollBottom()}),n.emit("put","/conversations/"+t.data.id+"/received")):s.add({id:"com.help.upplus4.notification.message",title:"Mensaje recibido",message:t.data.from.name+": "+t.data.type=="text"?t.data.message:"Imagen",json:{to:t.data.from.userid}}).then(function(e){console.log(e)})}),e.$on("conversation.updated",function(o,t){var n=_.findIndex(e.messages,{id:t.id});console.log("conv act",n,t),e.$apply(function(){e.messages[n].received=!0})}),e.ISentIt=function(e){return e.userid===a.user.id&&console.log("bien!"),e.userid===a.user.id},e.receivePicture=function(o){e.send(o,"image")},e.openImage=function(o){e.imageTap=o,c.fromTemplateUrl("templates/proveedores/imageModal.html",{scope:e,animation:"slide-in-up"}).then(function(o){e.modal=o,e.modal.show()}),e.closeModal=function(){e.modal.hide()}}}]),controllers.controller("NotificationsCtrl",["$scope","$state","$ionicPopover",function(e,o,t){e.goToChat=function(t){o.transitionTo("homepage.chat",{id:t}),e.popover.hide()},t.fromTemplateUrl("popover.html",{scope:e}).then(function(o){e.popover=o}),e.openPopover=function(o){e.popover.show(o)}}]),controllers.controller("ProfileCtrl",["$scope","$stateParams","Restangular","SessionService",function(e,o,t,n){t.one("user",o.id).get().then(function(o){e.user=o.data}),e.getInclude=function(){return parseInt(o.id)!==n.user.id?"templates/proveedores/profile/_profile_footer.html":"templates/proveedores/profile/_profile_footer_mine.html"},e.edit=function(){e.transitionTo("homepage.perfil.edit")}}]),controllers.controller("MensajesCtrl",["$scope","socket","$state",function(e,o,t){o.emit("get","/conversations",function(o){e.$apply(function(){e.conversations=o})}),e.goToChat=function(e){t.transitionTo("homepage.chat",{id:e})}}]);
angular.module("helpme.directives",[]).directive("helpmeNotifications",["$ionicPopover","$state",function(e,o){return{restrict:"E",scope:{messages:"="},replace:!0,template:'<button class="button button-clear button-stable" ng-click="open($event)"><i ng-class="{\'icon ion-chatbubbles\': hasMessages(), \'icon ion-chatbubble\': !hasMessages()}">{{ count }}</i></button>',link:function(t){t.count=0,t.hasMessages=function(){return t.count>0},t.$on("user.messaged",function(){console.log(t.messages),t.$apply(function(){t.count++})}),e.fromTemplateUrl("popover.html",{scope:t}).then(function(e){t.popover=e}),t.open=function(e){t.popover.show(e)},t.goToChat=function(e){_.remove(t.messages,function(o){return o.data.id==e.data.id}),t.popover.hide(),o.transitionTo("homepage.chat",{id:e.data.from.userid})}}}}]).directive("helpmeShare",["$ionicPopover","$cordovaCamera",function(e,o){return{restrict:"A",scope:{sendPicture:"&"},template:'<button class="button button-icon icon ion-share" ng-click="openPopover($event)"></button>',replace:!0,link:function(t){var n={quality:75,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.CAMERA,allowEdit:!1,encodingType:Camera.EncodingType.JPEG,saveToPhotoAlbum:!1};e.fromTemplateUrl("templates/proveedores/shareMenu.html",{scope:t}).then(function(e){t.popover=e}),t.openPopover=function(e){t.popover.show(e)},t.openCamera=function(){o.getPicture(n).then(function(e){t.popover.hide(),t.sendPicture({imageData:e})})}}}}]);
angular.module("helpme.filters",[]).filter("default",function(){return function(e,n){var r="No indica";return e?e:n||r}});
function SocketIO(e,o,t){this.io=e,this.socket=null,this.users=[],this.pendingRequests=[],o.users=[],o.usuario={},this.emit=function(e,o,n,s){var i=this;"string"==typeof s&&(e=s,s=null),"function"==typeof n&&(s=n,n={}),null==this.socket?(this.socket=this.io.connect(ENDPOINT,{query:"token="+t.token}),this.socket.on("connect",function(){i.bindEvents(),i.socket[e](o,n,function(e){return s(e)})})):this.socket[e](o,n,function(e){return s(e)})},this.bindEvents=function(){var e=this;e.socket.on("sessionuser",function(e){switch(console.log("evento!",e),e.verb){case"updated":_.each(o.users,function(t){t.id==e.id&&o.$apply(function(){t.name=e.data.name})});break;case"created":o.users.push(e.data),o.$broadcast("user.added",e.data);break;case"destroyed":o.$broadcast("user.destroyed",e.id);break;case"messaged":o.$broadcast("user.messaged",e)}})}}function SocketIO(e,o,t){this.io=e,this.socket=null,this.users=[],this.emit=function(e,o,n,s){var i=this;"undefined"==typeof s&&(s=null),"function"==typeof n&&(s=n,n={}),null==this.socket?(this.socket=this.io.connect(ENDPOINT,{query:"token="+t.token}),this.socket.on("connect",function(){i.bindEvents(),i.socket[e](o,n,function(e){return s&&s(e)})})):this.socket[e](o,n,function(e){return s&&s(e)})},this.bindEvents=function(){var e=this;e.socket.on("sessionuser",function(t){var n;switch(t.verb){case"updated":t.previous&&t.previous.socketId==e.socket.socket.sessionid?(console.log("llega, deslogueando"),o.$broadcast("user.session.close")):(n=_.findIndex(e.users,{userid:t.id}),e.users[n]=_.merge(e.users[n],t.data),o.$broadcast(t.data.online===!0?"user.logged_in":"user.destroyed"));break;case"created":_.findIndex(e.users,{userid:t.id})||(e.users.push(t.data),o.$broadcast("user.added",t.data));break;case"destroyed":if(t.previous&&t.previous.socketId==e.socket.socket.sessionid)o.$broadcast("user.session.close");else{var s=_.findIndex(e.users,function(e){return e.userid==t.id});e.users[s].online=!1,o.$broadcast("user.destroyed",s)}break;case"messaged":o.$broadcast("user.messaged",t)}}),e.socket.on("gps",function(e){switch(e.verb){case"created":o.$broadcast("gps.received",e);break;case"updated":o.$broadcast("gps.received",e)}}),e.socket.on("conversation",function(e){switch(e.verb){case"updated":o.$broadcast("conversation.updated",e.data)}})}}function SocketIO(e,o,t){this.io=e,this.socket=null,this.users=[],this.emit=function(e,o,n,s){var i=this;"undefined"==typeof s&&(s=null),"function"==typeof n&&(s=n,n={}),null==this.socket?(this.socket=this.io.connect(ENDPOINT,{query:"token="+t.token}),this.socket.on("connect",function(){i.bindEvents(),i.socket[e](o,n,function(e){return s&&s(e)})})):this.socket[e](o,n,function(e){return s&&s(e)})},this.bindEvents=function(){var e=this;e.socket.on("sessionuser",function(t){var n;switch(t.verb){case"updated":t.previous&&t.previous.socketId==e.socket.socket.sessionid?(console.log("llega, deslogueando"),o.$broadcast("user.session.close")):(n=_.findIndex(e.users,{userid:t.id}),e.users[n]=_.merge(e.users[n],t.data),o.$broadcast(t.data.online===!0?"user.logged_in":"user.destroyed"));break;case"created":_.findIndex(e.users,{userid:t.id})||(e.users.push(t.data),o.$broadcast("user.added",t.data));break;case"destroyed":if(t.previous&&t.previous.socketId==e.socket.socket.sessionid)o.$broadcast("user.session.close");else{var s=_.findIndex(e.users,function(e){return e.userid==t.id});e.users[s].online=!1,o.$broadcast("user.destroyed",s)}break;case"messaged":o.$broadcast("user.messaged",t)}}),e.socket.on("gps",function(e){switch(e.verb){case"created":o.$broadcast("gps.received",e);break;case"updated":o.$broadcast("gps.received",e)}}),e.socket.on("conversation",function(e){switch(e.verb){case"updated":o.$broadcast("conversation.updated",e.data)}})}}function SocketIO(e,o,t){this.io=e,this.socket=null,this.users=[],this.emit=function(e,o,n,s){var i=this;"undefined"==typeof s&&(s=null),"function"==typeof n&&(s=n,n={}),null==this.socket?(this.socket=this.io.connect(ENDPOINT,{query:"token="+t.token}),this.socket.on("connect",function(){i.bindEvents(),i.socket[e](o,n,function(e){return s&&s(e)})})):this.socket[e](o,n,function(e){return s&&s(e)})},this.bindEvents=function(){var e=this;e.socket.on("sessionuser",function(t){var n;switch(t.verb){case"updated":t.previous&&t.previous.socketId==e.socket.socket.sessionid?(console.log("llega, deslogueando"),o.$broadcast("user.session.close")):(n=_.findIndex(e.users,{userid:t.id}),e.users[n]=_.merge(e.users[n],t.data),o.$broadcast(t.data.online===!0?"user.logged_in":"user.destroyed"));break;case"created":_.findIndex(e.users,{userid:t.id})||(e.users.push(t.data),o.$broadcast("user.added",t.data));break;case"destroyed":if(t.previous&&t.previous.socketId==e.socket.socket.sessionid)o.$broadcast("user.session.close");else{var s=_.findIndex(e.users,function(e){return e.userid==t.id});e.users[s].online=!1,o.$broadcast("user.destroyed",s)}break;case"messaged":o.$broadcast("user.messaged",t)}}),e.socket.on("gps",function(e){switch(e.verb){case"created":o.$broadcast("gps.received",e);break;case"updated":o.$broadcast("gps.received",e)}}),e.socket.on("conversation",function(e){switch(e.verb){case"updated":o.$broadcast("conversation.updated",e.data)}})}}function SocketIO(e,o,t){this.io=e,this.socket=null,this.users=[],this.emit=function(e,o,n,s){var i=this;"undefined"==typeof s&&(s=null),"function"==typeof n&&(s=n,n={}),null==this.socket?(this.socket=this.io.connect(ENDPOINT,{query:"token="+t.token}),this.socket.on("connect",function(){i.bindEvents(),i.socket[e](o,n,function(e){return s&&s(e)})})):this.socket[e](o,n,function(e){return s&&s(e)})},this.bindEvents=function(){var e=this;e.socket.on("sessionuser",function(t){var n;switch(t.verb){case"updated":t.previous&&t.previous.socketId==e.socket.socket.sessionid?(console.log("llega, deslogueando"),o.$broadcast("user.session.close")):(n=_.findIndex(e.users,{userid:t.id}),e.users[n]=_.merge(e.users[n],t.data),o.$broadcast(t.data.online===!0?"user.logged_in":"user.destroyed"));break;case"created":_.findIndex(e.users,{userid:t.id})||(e.users.push(t.data),o.$broadcast("user.added",t.data));break;case"destroyed":if(t.previous&&t.previous.socketId==e.socket.socket.sessionid)o.$broadcast("user.session.close");else{var s=_.findIndex(e.users,function(e){return e.userid==t.id});e.users[s].online=!1,o.$broadcast("user.destroyed",s)}break;case"messaged":o.$broadcast("user.messaged",t)}}),e.socket.on("gps",function(e){switch(e.verb){case"created":o.$broadcast("gps.received",e);break;case"updated":o.$broadcast("gps.received",e)}}),e.socket.on("conversation",function(e){switch(e.verb){case"updated":o.$broadcast("conversation.updated",e.data)}})}}angular.module("helpme",["ionic","restangular","helpme.controllers","helpme.services","helpme.directives","helpme.filters","ngCordova","igTruncate"]).run(function(e,o,t,n){e.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&StatusBar.styleDefault(),window.plugin.notification.local.onclick=function(e,t,n){alert(JSON.parse(n).from),o.$broadcast("notification.local.click",{id:e,state:t,json:JSON.parse(n)})}}),o.$on("$stateChangeStart",function(e,o){o.data.requiresLogin&&!t.authenticated&&(e.preventDefault(),n.transitionTo("login"))})}).config(function(e,o,t,n,s){t.setBaseUrl(ENDPOINT),t.setFullResponse(!0),n.setIo(io),e.state("root",{url:"/",controller:function(e){e.transitionTo("login")},data:{requiresLogin:!1}}).state("login",{url:"/login",templateUrl:"templates/login.html",controller:"LoginCtrl",data:{requiresLogin:!1}}).state("homepage",{url:"/home","abstract":!0,controller:"HomepageCtrl",templateUrl:"templates/menu.html",data:{requiresLogin:!0}}).state("homepage.proveedores",{url:"/proveedores",views:{menuContent:{templateUrl:"templates/proveedores.html",controller:"ProveedoresCtrl"}},data:{requiresLogin:!0}}).state("homepage.mensajes",{url:"/proveedores/mensajes",views:{menuContent:{templateUrl:"templates/proveedores/mensajes.html",controller:"MensajesCtrl"}},data:{requiresLogin:!0}}).state("homepage.chat",{url:"/proveedores/chat/:id",views:{menuContent:{templateUrl:"templates/proveedores/show.html",controller:"ChatCtrl"}},data:{requiresLogin:!0}}).state("homepage.profile",{url:"/profile/:id",views:{menuContent:{templateUrl:"templates/proveedores/profile/profile.html",controller:"ProfileCtrl"}}}),o.otherwise("/"),s.interceptors.push("TokenInterceptor")}),ionic.Platform.ready(function(){window.plugin.notification.local.onclick=function(e,o,t){"com.help.upplus4.notification.message"==e&&$scope.apply(function(){$state.transitionTo("homepage.chat",{id:t.from})})}});var controllers;controllers=angular.module("helpme.controllers",[]),controllers.controller("LoginCtrl",["$scope","$state","SessionService","$ionicPopup","LoadingService","$cordovaSms",function(e,o,t,n,s){return e.loginData={},e.showBar=!1,e.login=function(e){s.show("Comprobando credenciales..."),t.login(e,function(e){s.hide(),200==e.status?o.transitionTo("homepage.proveedores"):n.alert({title:'<i class="icon ion-alert-circled"></i>  Usuario o contraseña inválida',template:"Compruebe las credenciales"})})}}]),controllers.controller("MainCtrl",function(e,o,t,n,s,i,r,a,c,l){e.messages=[],e.messageCount=0,e.user={},e.messages=[],e.total_users=0,e.incommingMessages=[],e.users=[],e.useGPS={status:!1},e.goToMessages=function(){o.transitionTo("messages")},e.$on("notification.local.click",function(t,n){"com.help.upplus4.notification.message"==n.id&&e.apply(function(){o.transitionTo("homepage.chat",{id:n.json.from})})}),e.$on("user.messaged",function(o,n){t.add({id:"com.help.upplus4.notification.message",title:"Mensaje recibido",message:n.data.from.name+": "+n.data.type=="text"?n.data.message:"Imagen",json:{from:n.data.from.userid}}).then(function(e){console.log(e)}),e.incommingMessages.push(n)}),e.goToProfile=function(){o.transitionTo("homepage.profile",{id:n.user.id})},e.logout=function(){n.logout(),o.transitionTo("login")},{notificationTitle:"Background tracking",notificationText:"ENABLED",debug:!0,url:ENDPOINT+"/gps",params:{from:n.user.id},headers:{authorization:r.sessionStorage.token},timeout:15e3,desiredAccuracy:10,stationaryRadius:20,distanceFilter:30,stopOnTerminate:!1,enableHighAccuracy:!0},e.$watch("useGPS.status",function(e){e&&i.getCurrentPosition({enableHighAccuracy:!0,maximumAge:3e3,timeout:6e4}).then(function(e){a.emit("post","/gps/receive",{position:e,from:n.user.id})},function(e){alert(e)})}),e.$on("gps.received",function(e,o){console.log(o),c.showLongCenter("Usuario "+o.data.user+"ubicado en: "+o.data.latitude+o.data.longitude)}),e.$on("user.session.close",function(){n.logout(),l.alert({title:"Nueva sesión",template:"Se ha iniciado sesión en otra ubicación"}).then(function(){o.transitionTo("login")})})}),controllers.controller("HomepageCtrl",function(){}),controllers.controller("ProveedoresCtrl",["$scope","socket","$window","$ionicActionSheet","$state","SessionService",function(e,o,t,n,s){o.emit("get","/sessionuser/list",function(t){e.$apply(function(){e.users=o.users=t})}),e.$on("user.added",function(o,t){e.$apply(function(){e.users.push(t)})}),e.$on("user.logged_in",function(){e.$apply(function(){})}),e.$on("user.destroyed",function(){e.$apply(function(){})}),e.openSheet=function(e){n.show({buttons:[{text:'<i class="icon ion-person"></i> Ver perfil'},{text:'<i class="icon ion-chatbox"></i> Enviar mensaje'}],titleText:"Acciones",buttonClicked:function(o){1==o&&s.transitionTo("homepage.chat",{id:e}),0==o&&s.transitionTo("homepage.profile",{id:e})}})};var i=!0;e.needToLoad=function(){return o.users.length>=10&&i},e.loadMore=function(){o.emit("get","/sessionuser/list",{skip:o.users.length},function(t){0==t.length&&(i=!1),e.$apply(function(){e.users=o.users=o.users.concat(t),e.$broadcast("scroll.infiniteScrollComplete")})})}}]),controllers.controller("ChatCtrl",["$scope","$rootScope","$stateParams","socket","$cordovaLocalNotification","$window","SessionService","$ionicScrollDelegate","$ionicModal",function(e,o,t,n,s,i,r,a,c){var l=t.id;n.socket.get("/conversations/"+r.user.id+"/"+l,{headers:{Authorization:i.sessionStorage.token}},function(o){e.$apply(function(){a.$getByHandle("chat").scrollBottom(),e.messages=o})}),n.socket.get("/sessionuser/"+l,function(o){e.user=o}),e.send=function(o,t){e.newMessage="",e.messages.push({id:-1,type:t,message:o,createdAt:new Date,from:r.user.user,sent:!1,received:!1}),n.socket.post("/sessionuser/message/",{to:l,message:o,type:t},function(o){e.$apply(function(){var t=_.findIndex(e.messages,{id:-1});e.messages[t]=o,a.$getByHandle("chat").scrollBottom()})})},e.$on("user.messaged",function(o,t){t.data.from.userid==l?(e.$apply(function(){e.messages.push(t.data),a.$getByHandle("chat").scrollBottom()}),n.emit("put","/conversations/"+t.data.id+"/received")):s.add({id:"com.help.upplus4.notification.message",title:"Mensaje recibido",message:t.data.from.name+": "+t.data.type=="text"?t.data.message:"Imagen",json:{to:t.data.from.userid}}).then(function(e){console.log(e)})}),e.$on("conversation.updated",function(o,t){var n=_.findIndex(e.messages,{id:t.id});console.log("conv act",n,t),e.$apply(function(){e.messages[n].received=!0})}),e.ISentIt=function(e){return e.userid===r.user.id&&console.log("bien!"),e.userid===r.user.id},e.receivePicture=function(o){e.send(o,"image")},e.openImage=function(o){e.imageTap=o,c.fromTemplateUrl("templates/proveedores/imageModal.html",{scope:e,animation:"slide-in-up"}).then(function(o){e.modal=o,e.modal.show()}),e.closeModal=function(){e.modal.hide()}}}]),controllers.controller("NotificationsCtrl",["$scope","$state","$ionicPopover",function(e,o,t){e.goToChat=function(t){o.transitionTo("homepage.chat",{id:t}),e.popover.hide()},t.fromTemplateUrl("popover.html",{scope:e}).then(function(o){e.popover=o}),e.openPopover=function(o){e.popover.show(o)}}]),controllers.controller("ProfileCtrl",["$scope","$stateParams","Restangular","SessionService",function(e,o,t,n){t.one("user",o.id).get().then(function(o){e.user=o.data}),e.getInclude=function(){return parseInt(o.id)!==n.user.id?"templates/proveedores/profile/_profile_footer.html":"templates/proveedores/profile/_profile_footer_mine.html"},e.edit=function(){e.transitionTo("homepage.perfil.edit")}}]),controllers.controller("MensajesCtrl",["$scope","socket","$state",function(e,o,t){o.emit("get","/conversations",function(o){e.$apply(function(){e.conversations=o})}),e.goToChat=function(e){t.transitionTo("homepage.chat",{id:e})}}]),angular.module("helpme.directives",[]).directive("helpmeNotifications",["$ionicPopover","$state",function(e,o){return{restrict:"E",scope:{messages:"="},replace:!0,template:'<button class="button button-clear button-stable" ng-click="open($event)"><i ng-class="{\'icon ion-chatbubbles\': hasMessages(), \'icon ion-chatbubble\': !hasMessages()}">{{ count }}</i></button>',link:function(t){t.count=0,t.hasMessages=function(){return t.count>0},t.$on("user.messaged",function(){console.log(t.messages),t.$apply(function(){t.count++})}),e.fromTemplateUrl("popover.html",{scope:t}).then(function(e){t.popover=e}),t.open=function(e){t.popover.show(e)},t.goToChat=function(e){_.remove(t.messages,function(o){return o.data.id==e.data.id}),t.popover.hide(),o.transitionTo("homepage.chat",{id:e.data.from.userid})}}}}]).directive("helpmeShare",["$ionicPopover","$cordovaCamera",function(e,o){return{restrict:"A",scope:{sendPicture:"&"},template:'<button class="button button-icon icon ion-share" ng-click="openPopover($event)"></button>',replace:!0,link:function(t){var n={quality:75,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.CAMERA,allowEdit:!1,encodingType:Camera.EncodingType.JPEG,saveToPhotoAlbum:!1};e.fromTemplateUrl("templates/proveedores/shareMenu.html",{scope:t}).then(function(e){t.popover=e}),t.openPopover=function(e){t.popover.show(e)},t.openCamera=function(){o.getPicture(n).then(function(e){t.popover.hide(),t.sendPicture({imageData:e})})}}}}]),angular.module("helpme.filters",[]).filter("default",function(){return function(e,o){var t="No indica";return e?e:o||t}}),angular.module("helpme",["ionic","restangular","helpme.controllers","helpme.services","helpme.directives","helpme.filters","ngCordova","igTruncate"]).run(function(e,o,t,n){e.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&StatusBar.styleDefault(),window.plugin.notification.local.onclick=function(e,t,n){alert(JSON.parse(n).from),o.$broadcast("notification.local.click",{id:e,state:t,json:JSON.parse(n)})}}),o.$on("$stateChangeStart",function(e,o){o.data.requiresLogin&&!t.authenticated&&(e.preventDefault(),n.transitionTo("login"))})}).config(function(e,o,t,n,s){t.setBaseUrl(ENDPOINT),t.setFullResponse(!0),n.setIo(io),e.state("root",{url:"/",controller:function(e){e.transitionTo("login")},data:{requiresLogin:!1}}).state("login",{url:"/login",templateUrl:"templates/login.html",controller:"LoginCtrl",data:{requiresLogin:!1}}).state("homepage",{url:"/home","abstract":!0,controller:"HomepageCtrl",templateUrl:"templates/menu.html",data:{requiresLogin:!0}}).state("homepage.proveedores",{url:"/proveedores",views:{menuContent:{templateUrl:"templates/proveedores.html",controller:"ProveedoresCtrl"}},data:{requiresLogin:!0}}).state("homepage.mensajes",{url:"/proveedores/mensajes",views:{menuContent:{templateUrl:"templates/proveedores/mensajes.html",controller:"MensajesCtrl"}},data:{requiresLogin:!0}}).state("homepage.chat",{url:"/proveedores/chat/:id",views:{menuContent:{templateUrl:"templates/proveedores/show.html",controller:"ChatCtrl"}},data:{requiresLogin:!0}}).state("homepage.profile",{url:"/profile/:id",views:{menuContent:{templateUrl:"templates/proveedores/profile/profile.html",controller:"ProfileCtrl"}}}),o.otherwise("/"),s.interceptors.push("TokenInterceptor")}),ionic.Platform.ready(function(){window.plugin.notification.local.onclick=function(e,o,t){"com.help.upplus4.notification.message"==e&&$scope.apply(function(){$state.transitionTo("homepage.chat",{id:t.from})})}});var controllers;controllers=angular.module("helpme.controllers",[]),controllers.controller("LoginCtrl",["$scope","$state","SessionService","$ionicPopup","LoadingService","$cordovaSms",function(e,o,t,n,s){return e.loginData={},e.showBar=!1,e.login=function(e){s.show("Comprobando credenciales..."),t.login(e,function(e){s.hide(),200==e.status?o.transitionTo("homepage.proveedores"):n.alert({title:'<i class="icon ion-alert-circled"></i>  Usuario o contraseña inválida',template:"Compruebe las credenciales"})})}}]),controllers.controller("MainCtrl",function(e,o,t,n,s,i,r,a,c,l){e.messages=[],e.messageCount=0,e.user={},e.messages=[],e.total_users=0,e.incommingMessages=[],e.users=[],e.useGPS={status:!1},e.goToMessages=function(){o.transitionTo("messages")},e.$on("notification.local.click",function(t,n){"com.help.upplus4.notification.message"==n.id&&e.apply(function(){o.transitionTo("homepage.chat",{id:n.json.from})})}),e.$on("user.messaged",function(o,n){t.add({id:"com.help.upplus4.notification.message",title:"Mensaje recibido",message:n.data.from.name+": "+n.data.type=="text"?n.data.message:"Imagen",json:{from:n.data.from.userid}}).then(function(e){console.log(e)}),e.incommingMessages.push(n)}),e.goToProfile=function(){o.transitionTo("homepage.profile",{id:n.user.id})},e.logout=function(){n.logout(),o.transitionTo("login")},{notificationTitle:"Background tracking",notificationText:"ENABLED",debug:!0,url:ENDPOINT+"/gps",params:{from:n.user.id},headers:{authorization:r.sessionStorage.token},timeout:15e3,desiredAccuracy:10,stationaryRadius:20,distanceFilter:30,stopOnTerminate:!1,enableHighAccuracy:!0},e.$watch("useGPS.status",function(e){e&&i.getCurrentPosition({enableHighAccuracy:!0,maximumAge:3e3,timeout:6e4}).then(function(e){a.emit("post","/gps/receive",{position:e,from:n.user.id})},function(e){alert(e)})}),e.$on("gps.received",function(e,o){console.log(o),c.showLongCenter("Usuario "+o.data.user+"ubicado en: "+o.data.latitude+o.data.longitude)}),e.$on("user.session.close",function(){n.logout(),l.alert({title:"Nueva sesión",template:"Se ha iniciado sesión en otra ubicación"}).then(function(){o.transitionTo("login")})})}),controllers.controller("HomepageCtrl",function(){}),controllers.controller("ProveedoresCtrl",["$scope","socket","$window","$ionicActionSheet","$state","SessionService",function(e,o,t,n,s){o.emit("get","/sessionuser/list",function(t){e.$apply(function(){e.users=o.users=t})}),e.$on("user.added",function(o,t){e.$apply(function(){e.users.push(t)})}),e.$on("user.logged_in",function(){e.$apply(function(){})}),e.$on("user.destroyed",function(){e.$apply(function(){})}),e.openSheet=function(e){n.show({buttons:[{text:'<i class="icon ion-person"></i> Ver perfil'},{text:'<i class="icon ion-chatbox"></i> Enviar mensaje'}],titleText:"Acciones",buttonClicked:function(o){1==o&&s.transitionTo("homepage.chat",{id:e}),0==o&&s.transitionTo("homepage.profile",{id:e})}})};var i=!0;e.needToLoad=function(){return o.users.length>=10&&i},e.loadMore=function(){o.emit("get","/sessionuser/list",{skip:o.users.length},function(t){0==t.length&&(i=!1),e.$apply(function(){e.users=o.users=o.users.concat(t),e.$broadcast("scroll.infiniteScrollComplete")})})}}]),controllers.controller("ChatCtrl",["$scope","$rootScope","$stateParams","socket","$cordovaLocalNotification","$window","SessionService","$ionicScrollDelegate","$ionicModal",function(e,o,t,n,s,i,r,a,c){var l=t.id;n.socket.get("/conversations/"+r.user.id+"/"+l,{headers:{Authorization:i.sessionStorage.token}},function(o){e.$apply(function(){a.$getByHandle("chat").scrollBottom(),e.messages=o})}),n.socket.get("/sessionuser/"+l,function(o){e.user=o}),e.send=function(o,t){e.newMessage="",e.messages.push({id:-1,type:t,message:o,createdAt:new Date,from:r.user.user,sent:!1,received:!1}),n.socket.post("/sessionuser/message/",{to:l,message:o,type:t},function(o){e.$apply(function(){var t=_.findIndex(e.messages,{id:-1});e.messages[t]=o,a.$getByHandle("chat").scrollBottom()})})},e.$on("user.messaged",function(o,t){t.data.from.userid==l?(e.$apply(function(){e.messages.push(t.data),a.$getByHandle("chat").scrollBottom()}),n.emit("put","/conversations/"+t.data.id+"/received")):s.add({id:"com.help.upplus4.notification.message",title:"Mensaje recibido",message:t.data.from.name+": "+t.data.type=="text"?t.data.message:"Imagen",json:{to:t.data.from.userid}}).then(function(e){console.log(e)})}),e.$on("conversation.updated",function(o,t){var n=_.findIndex(e.messages,{id:t.id});console.log("conv act",n,t),e.$apply(function(){e.messages[n].received=!0})}),e.ISentIt=function(e){return e.userid===r.user.id&&console.log("bien!"),e.userid===r.user.id},e.receivePicture=function(o){e.send(o,"image")},e.openImage=function(o){e.imageTap=o,c.fromTemplateUrl("templates/proveedores/imageModal.html",{scope:e,animation:"slide-in-up"}).then(function(o){e.modal=o,e.modal.show()}),e.closeModal=function(){e.modal.hide()}}}]),controllers.controller("NotificationsCtrl",["$scope","$state","$ionicPopover",function(e,o,t){e.goToChat=function(t){o.transitionTo("homepage.chat",{id:t}),e.popover.hide()},t.fromTemplateUrl("popover.html",{scope:e}).then(function(o){e.popover=o}),e.openPopover=function(o){e.popover.show(o)}}]),controllers.controller("ProfileCtrl",["$scope","$stateParams","Restangular","SessionService",function(e,o,t,n){t.one("user",o.id).get().then(function(o){e.user=o.data}),e.getInclude=function(){return parseInt(o.id)!==n.user.id?"templates/proveedores/profile/_profile_footer.html":"templates/proveedores/profile/_profile_footer_mine.html"},e.edit=function(){e.transitionTo("homepage.perfil.edit")}}]),controllers.controller("MensajesCtrl",["$scope","socket","$state",function(e,o,t){o.emit("get","/conversations",function(o){e.$apply(function(){e.conversations=o})}),e.goToChat=function(e){t.transitionTo("homepage.chat",{id:e})}}]),angular.module("helpme.directives",[]).directive("helpmeNotifications",["$ionicPopover","$state",function(e,o){return{restrict:"E",scope:{messages:"="},replace:!0,template:'<button class="button button-clear button-stable" ng-click="open($event)"><i ng-class="{\'icon ion-chatbubbles\': hasMessages(), \'icon ion-chatbubble\': !hasMessages()}">{{ count }}</i></button>',link:function(t){t.count=0,t.hasMessages=function(){return t.count>0},t.$on("user.messaged",function(){console.log(t.messages),t.$apply(function(){t.count++})}),e.fromTemplateUrl("popover.html",{scope:t}).then(function(e){t.popover=e}),t.open=function(e){t.popover.show(e)},t.goToChat=function(e){_.remove(t.messages,function(o){return o.data.id==e.data.id}),t.popover.hide(),o.transitionTo("homepage.chat",{id:e.data.from.userid})}}}}]).directive("helpmeShare",["$ionicPopover","$cordovaCamera",function(e,o){return{restrict:"A",scope:{sendPicture:"&"},template:'<button class="button button-icon icon ion-share" ng-click="openPopover($event)"></button>',replace:!0,link:function(t){var n={quality:75,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.CAMERA,allowEdit:!1,encodingType:Camera.EncodingType.JPEG,saveToPhotoAlbum:!1};e.fromTemplateUrl("templates/proveedores/shareMenu.html",{scope:t}).then(function(e){t.popover=e}),t.openPopover=function(e){t.popover.show(e)},t.openCamera=function(){o.getPicture(n).then(function(e){t.popover.hide(),t.sendPicture({imageData:e})})}}}}]),angular.module("helpme.filters",[]).filter("default",function(){return function(e,o){var t="No indica";return e?e:o||t}}),angular.module("helpme",["ionic","restangular","helpme.controllers","helpme.services","helpme.directives","helpme.filters","ngCordova","igTruncate"]).run(function(e,o,t,n){e.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&StatusBar.styleDefault(),window.plugin.notification.local.onclick=function(e,t,n){alert(JSON.parse(n).from),o.$broadcast("notification.local.click",{id:e,state:t,json:JSON.parse(n)})}}),o.$on("$stateChangeStart",function(e,o){o.data.requiresLogin&&!t.authenticated&&(e.preventDefault(),n.transitionTo("login"))})}).config(function(e,o,t,n,s){t.setBaseUrl(ENDPOINT),t.setFullResponse(!0),n.setIo(io),e.state("root",{url:"/",controller:function(e){e.transitionTo("login")},data:{requiresLogin:!1}}).state("login",{url:"/login",templateUrl:"templates/login.html",controller:"LoginCtrl",data:{requiresLogin:!1}}).state("homepage",{url:"/home","abstract":!0,controller:"HomepageCtrl",templateUrl:"templates/menu.html",data:{requiresLogin:!0}}).state("homepage.proveedores",{url:"/proveedores",views:{menuContent:{templateUrl:"templates/proveedores.html",controller:"ProveedoresCtrl"}},data:{requiresLogin:!0}}).state("homepage.mensajes",{url:"/proveedores/mensajes",views:{menuContent:{templateUrl:"templates/proveedores/mensajes.html",controller:"MensajesCtrl"}},data:{requiresLogin:!0}}).state("homepage.chat",{url:"/proveedores/chat/:id",views:{menuContent:{templateUrl:"templates/proveedores/show.html",controller:"ChatCtrl"}},data:{requiresLogin:!0}}).state("homepage.profile",{url:"/profile/:id",views:{menuContent:{templateUrl:"templates/proveedores/profile/profile.html",controller:"ProfileCtrl"}}}),o.otherwise("/"),s.interceptors.push("TokenInterceptor")}),ionic.Platform.ready(function(){window.plugin.notification.local.onclick=function(e,o,t){"com.help.upplus4.notification.message"==e&&$scope.apply(function(){$state.transitionTo("homepage.chat",{id:t.from})})}});var controllers;controllers=angular.module("helpme.controllers",[]),controllers.controller("LoginCtrl",["$scope","$state","SessionService","$ionicPopup","LoadingService","$cordovaSms",function(e,o,t,n,s){return e.loginData={},e.showBar=!1,e.login=function(e){s.show("Comprobando credenciales..."),t.login(e,function(e){s.hide(),200==e.status?o.transitionTo("homepage.proveedores"):n.alert({title:'<i class="icon ion-alert-circled"></i>  Usuario o contraseña inválida',template:"Compruebe las credenciales"})})}}]),controllers.controller("MainCtrl",function(e,o,t,n,s,i,r,a,c,l){e.messages=[],e.messageCount=0,e.user={},e.messages=[],e.total_users=0,e.incommingMessages=[],e.users=[],e.useGPS={status:!1},e.goToMessages=function(){o.transitionTo("messages")},e.$on("notification.local.click",function(t,n){"com.help.upplus4.notification.message"==n.id&&e.apply(function(){o.transitionTo("homepage.chat",{id:n.json.from})})}),e.$on("user.messaged",function(o,n){t.add({id:"com.help.upplus4.notification.message",title:"Mensaje recibido",message:n.data.from.name+": "+n.data.type=="text"?n.data.message:"Imagen",json:{from:n.data.from.userid}}).then(function(e){console.log(e)}),e.incommingMessages.push(n)}),e.goToProfile=function(){o.transitionTo("homepage.profile",{id:n.user.id})},e.logout=function(){n.logout(),o.transitionTo("login")},{notificationTitle:"Background tracking",notificationText:"ENABLED",debug:!0,url:ENDPOINT+"/gps",params:{from:n.user.id},headers:{authorization:r.sessionStorage.token},timeout:15e3,desiredAccuracy:10,stationaryRadius:20,distanceFilter:30,stopOnTerminate:!1,enableHighAccuracy:!0},e.$watch("useGPS.status",function(e){e&&i.getCurrentPosition({enableHighAccuracy:!0,maximumAge:3e3,timeout:6e4}).then(function(e){a.emit("post","/gps/receive",{position:e,from:n.user.id})},function(e){alert(e)})}),e.$on("gps.received",function(e,o){console.log(o),c.showLongCenter("Usuario "+o.data.user+"ubicado en: "+o.data.latitude+o.data.longitude)}),e.$on("user.session.close",function(){n.logout(),l.alert({title:"Nueva sesión",template:"Se ha iniciado sesión en otra ubicación"}).then(function(){o.transitionTo("login")})})}),controllers.controller("HomepageCtrl",function(){}),controllers.controller("ProveedoresCtrl",["$scope","socket","$window","$ionicActionSheet","$state","SessionService",function(e,o,t,n,s){o.emit("get","/sessionuser/list",function(t){e.$apply(function(){e.users=o.users=t})}),e.$on("user.added",function(o,t){e.$apply(function(){e.users.push(t)})}),e.$on("user.logged_in",function(){e.$apply(function(){})}),e.$on("user.destroyed",function(){e.$apply(function(){})}),e.openSheet=function(e){n.show({buttons:[{text:'<i class="icon ion-person"></i> Ver perfil'},{text:'<i class="icon ion-chatbox"></i> Enviar mensaje'}],titleText:"Acciones",buttonClicked:function(o){1==o&&s.transitionTo("homepage.chat",{id:e}),0==o&&s.transitionTo("homepage.profile",{id:e})}})};var i=!0;e.needToLoad=function(){return o.users.length>=10&&i},e.loadMore=function(){o.emit("get","/sessionuser/list",{skip:o.users.length},function(t){0==t.length&&(i=!1),e.$apply(function(){e.users=o.users=o.users.concat(t),e.$broadcast("scroll.infiniteScrollComplete")})})}}]),controllers.controller("ChatCtrl",["$scope","$rootScope","$stateParams","socket","$cordovaLocalNotification","$window","SessionService","$ionicScrollDelegate","$ionicModal",function(e,o,t,n,s,i,r,a,c){var l=t.id;n.socket.get("/conversations/"+r.user.id+"/"+l,{headers:{Authorization:i.sessionStorage.token}},function(o){e.$apply(function(){a.$getByHandle("chat").scrollBottom(),e.messages=o})}),n.socket.get("/sessionuser/"+l,function(o){e.user=o}),e.send=function(o,t){e.newMessage="",e.messages.push({id:-1,type:t,message:o,createdAt:new Date,from:r.user.user,sent:!1,received:!1}),n.socket.post("/sessionuser/message/",{to:l,message:o,type:t},function(o){e.$apply(function(){var t=_.findIndex(e.messages,{id:-1});e.messages[t]=o,a.$getByHandle("chat").scrollBottom()})})},e.$on("user.messaged",function(o,t){t.data.from.userid==l?(e.$apply(function(){e.messages.push(t.data),a.$getByHandle("chat").scrollBottom()}),n.emit("put","/conversations/"+t.data.id+"/received")):s.add({id:"com.help.upplus4.notification.message",title:"Mensaje recibido",message:t.data.from.name+": "+t.data.type=="text"?t.data.message:"Imagen",json:{to:t.data.from.userid}}).then(function(e){console.log(e)})}),e.$on("conversation.updated",function(o,t){var n=_.findIndex(e.messages,{id:t.id});console.log("conv act",n,t),e.$apply(function(){e.messages[n].received=!0
})}),e.ISentIt=function(e){return e.userid===r.user.id&&console.log("bien!"),e.userid===r.user.id},e.receivePicture=function(o){e.send(o,"image")},e.openImage=function(o){e.imageTap=o,c.fromTemplateUrl("templates/proveedores/imageModal.html",{scope:e,animation:"slide-in-up"}).then(function(o){e.modal=o,e.modal.show()}),e.closeModal=function(){e.modal.hide()}}}]),controllers.controller("NotificationsCtrl",["$scope","$state","$ionicPopover",function(e,o,t){e.goToChat=function(t){o.transitionTo("homepage.chat",{id:t}),e.popover.hide()},t.fromTemplateUrl("popover.html",{scope:e}).then(function(o){e.popover=o}),e.openPopover=function(o){e.popover.show(o)}}]),controllers.controller("ProfileCtrl",["$scope","$stateParams","Restangular","SessionService",function(e,o,t,n){t.one("user",o.id).get().then(function(o){e.user=o.data}),e.getInclude=function(){return parseInt(o.id)!==n.user.id?"templates/proveedores/profile/_profile_footer.html":"templates/proveedores/profile/_profile_footer_mine.html"},e.edit=function(){e.transitionTo("homepage.perfil.edit")}}]),controllers.controller("MensajesCtrl",["$scope","socket","$state",function(e,o,t){o.emit("get","/conversations",function(o){e.$apply(function(){e.conversations=o})}),e.goToChat=function(e){t.transitionTo("homepage.chat",{id:e})}}]),angular.module("helpme.directives",[]).directive("helpmeNotifications",["$ionicPopover","$state",function(e,o){return{restrict:"E",scope:{messages:"="},replace:!0,template:'<button class="button button-clear button-stable" ng-click="open($event)"><i ng-class="{\'icon ion-chatbubbles\': hasMessages(), \'icon ion-chatbubble\': !hasMessages()}">{{ count }}</i></button>',link:function(t){t.count=0,t.hasMessages=function(){return t.count>0},t.$on("user.messaged",function(){console.log(t.messages),t.$apply(function(){t.count++})}),e.fromTemplateUrl("popover.html",{scope:t}).then(function(e){t.popover=e}),t.open=function(e){t.popover.show(e)},t.goToChat=function(e){_.remove(t.messages,function(o){return o.data.id==e.data.id}),t.popover.hide(),o.transitionTo("homepage.chat",{id:e.data.from.userid})}}}}]).directive("helpmeShare",["$ionicPopover","$cordovaCamera",function(e,o){return{restrict:"A",scope:{sendPicture:"&"},template:'<button class="button button-icon icon ion-share" ng-click="openPopover($event)"></button>',replace:!0,link:function(t){var n={quality:75,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.CAMERA,allowEdit:!1,encodingType:Camera.EncodingType.JPEG,saveToPhotoAlbum:!1};e.fromTemplateUrl("templates/proveedores/shareMenu.html",{scope:t}).then(function(e){t.popover=e}),t.openPopover=function(e){t.popover.show(e)},t.openCamera=function(){o.getPicture(n).then(function(e){t.popover.hide(),t.sendPicture({imageData:e})})}}}}]),angular.module("helpme.filters",[]).filter("default",function(){return function(e,o){var t="No indica";return e?e:o||t}}),angular.module("helpme",["ionic","restangular","helpme.controllers","helpme.services","helpme.directives","helpme.filters","ngCordova","igTruncate"]).run(function(e,o,t,n){e.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&StatusBar.styleDefault(),window.plugin.notification.local.onclick=function(e,t,n){alert(JSON.parse(n).from),o.$broadcast("notification.local.click",{id:e,state:t,json:JSON.parse(n)})}}),o.$on("$stateChangeStart",function(e,o){o.data.requiresLogin&&!t.authenticated&&(e.preventDefault(),n.transitionTo("login"))})}).config(function(e,o,t,n,s){t.setBaseUrl(ENDPOINT),t.setFullResponse(!0),n.setIo(io),e.state("root",{url:"/",controller:function(e){e.transitionTo("login")},data:{requiresLogin:!1}}).state("login",{url:"/login",templateUrl:"templates/login.html",controller:"LoginCtrl",data:{requiresLogin:!1}}).state("homepage",{url:"/home","abstract":!0,controller:"HomepageCtrl",templateUrl:"templates/menu.html",data:{requiresLogin:!0}}).state("homepage.proveedores",{url:"/proveedores",views:{menuContent:{templateUrl:"templates/proveedores.html",controller:"ProveedoresCtrl"}},data:{requiresLogin:!0}}).state("homepage.mensajes",{url:"/proveedores/mensajes",views:{menuContent:{templateUrl:"templates/proveedores/mensajes.html",controller:"MensajesCtrl"}},data:{requiresLogin:!0}}).state("homepage.chat",{url:"/proveedores/chat/:id",views:{menuContent:{templateUrl:"templates/proveedores/show.html",controller:"ChatCtrl"}},data:{requiresLogin:!0}}).state("homepage.profile",{url:"/profile/:id",views:{menuContent:{templateUrl:"templates/proveedores/profile/profile.html",controller:"ProfileCtrl"}}}),o.otherwise("/"),s.interceptors.push("TokenInterceptor")}),ionic.Platform.ready(function(){window.plugin.notification.local.onclick=function(e,o,t){"com.help.upplus4.notification.message"==e&&$scope.apply(function(){$state.transitionTo("homepage.chat",{id:t.from})})}});var controllers;controllers=angular.module("helpme.controllers",[]),controllers.controller("LoginCtrl",["$scope","$state","SessionService","$ionicPopup","LoadingService","$cordovaSms",function(e,o,t,n,s){return e.loginData={},e.showBar=!1,e.login=function(e){s.show("Comprobando credenciales..."),t.login(e,function(e){s.hide(),200==e.status?o.transitionTo("homepage.proveedores"):n.alert({title:'<i class="icon ion-alert-circled"></i>  Usuario o contraseña inválida',template:"Compruebe las credenciales"})})}}]),controllers.controller("MainCtrl",function(e,o,t,n,s,i,r,a,c,l){e.messages=[],e.messageCount=0,e.user={},e.messages=[],e.total_users=0,e.incommingMessages=[],e.users=[],e.useGPS={status:!1},e.goToMessages=function(){o.transitionTo("messages")},e.$on("notification.local.click",function(t,n){"com.help.upplus4.notification.message"==n.id&&e.apply(function(){o.transitionTo("homepage.chat",{id:n.json.from})})}),e.$on("user.messaged",function(o,n){t.add({id:"com.help.upplus4.notification.message",title:"Mensaje recibido",message:n.data.from.name+": "+n.data.type=="text"?n.data.message:"Imagen",json:{from:n.data.from.userid}}).then(function(e){console.log(e)}),e.incommingMessages.push(n)}),e.goToProfile=function(){o.transitionTo("homepage.profile",{id:n.user.id})},e.logout=function(){n.logout(),o.transitionTo("login")},{notificationTitle:"Background tracking",notificationText:"ENABLED",debug:!0,url:ENDPOINT+"/gps",params:{from:n.user.id},headers:{authorization:r.sessionStorage.token},timeout:15e3,desiredAccuracy:10,stationaryRadius:20,distanceFilter:30,stopOnTerminate:!1,enableHighAccuracy:!0},e.$watch("useGPS.status",function(e){e&&i.getCurrentPosition({enableHighAccuracy:!0,maximumAge:3e3,timeout:6e4}).then(function(e){a.emit("post","/gps/receive",{position:e,from:n.user.id})},function(e){alert(e)})}),e.$on("gps.received",function(e,o){console.log(o),c.showLongCenter("Usuario "+o.data.user+"ubicado en: "+o.data.latitude+o.data.longitude)}),e.$on("user.session.close",function(){n.logout(),l.alert({title:"Nueva sesión",template:"Se ha iniciado sesión en otra ubicación"}).then(function(){o.transitionTo("login")})})}),controllers.controller("HomepageCtrl",function(){}),controllers.controller("ProveedoresCtrl",["$scope","socket","$window","$ionicActionSheet","$state","SessionService",function(e,o,t,n,s){o.emit("get","/sessionuser/list",function(t){e.$apply(function(){e.users=o.users=t})}),e.$on("user.added",function(o,t){e.$apply(function(){e.users.push(t)})}),e.$on("user.logged_in",function(){e.$apply(function(){})}),e.$on("user.destroyed",function(){e.$apply(function(){})}),e.openSheet=function(e){n.show({buttons:[{text:'<i class="icon ion-person"></i> Ver perfil'},{text:'<i class="icon ion-chatbox"></i> Enviar mensaje'}],titleText:"Acciones",buttonClicked:function(o){1==o&&s.transitionTo("homepage.chat",{id:e}),0==o&&s.transitionTo("homepage.profile",{id:e})}})};var i=!0;e.needToLoad=function(){return o.users.length>=10&&i},e.loadMore=function(){o.emit("get","/sessionuser/list",{skip:o.users.length},function(t){0==t.length&&(i=!1),e.$apply(function(){e.users=o.users=o.users.concat(t),e.$broadcast("scroll.infiniteScrollComplete")})})}}]),controllers.controller("ChatCtrl",["$scope","$rootScope","$stateParams","socket","$cordovaLocalNotification","$window","SessionService","$ionicScrollDelegate","$ionicModal",function(e,o,t,n,s,i,r,a,c){var l=t.id;n.socket.get("/conversations/"+r.user.id+"/"+l,{headers:{Authorization:i.sessionStorage.token}},function(o){e.$apply(function(){a.$getByHandle("chat").scrollBottom(),e.messages=o})}),n.socket.get("/sessionuser/"+l,function(o){e.user=o}),e.send=function(o,t){e.newMessage="",e.messages.push({id:-1,type:t,message:o,createdAt:new Date,from:r.user.user,sent:!1,received:!1}),n.socket.post("/sessionuser/message/",{to:l,message:o,type:t},function(o){e.$apply(function(){var t=_.findIndex(e.messages,{id:-1});e.messages[t]=o,a.$getByHandle("chat").scrollBottom()})})},e.$on("user.messaged",function(o,t){t.data.from.userid==l?(e.$apply(function(){e.messages.push(t.data),a.$getByHandle("chat").scrollBottom()}),n.emit("put","/conversations/"+t.data.id+"/received")):s.add({id:"com.help.upplus4.notification.message",title:"Mensaje recibido",message:t.data.from.name+": "+t.data.type=="text"?t.data.message:"Imagen",json:{to:t.data.from.userid}}).then(function(e){console.log(e)})}),e.$on("conversation.updated",function(o,t){var n=_.findIndex(e.messages,{id:t.id});console.log("conv act",n,t),e.$apply(function(){e.messages[n].received=!0})}),e.ISentIt=function(e){return e.userid===r.user.id&&console.log("bien!"),e.userid===r.user.id},e.receivePicture=function(o){e.send(o,"image")},e.openImage=function(o){e.imageTap=o,c.fromTemplateUrl("templates/proveedores/imageModal.html",{scope:e,animation:"slide-in-up"}).then(function(o){e.modal=o,e.modal.show()}),e.closeModal=function(){e.modal.hide()}}}]),controllers.controller("NotificationsCtrl",["$scope","$state","$ionicPopover",function(e,o,t){e.goToChat=function(t){o.transitionTo("homepage.chat",{id:t}),e.popover.hide()},t.fromTemplateUrl("popover.html",{scope:e}).then(function(o){e.popover=o}),e.openPopover=function(o){e.popover.show(o)}}]),controllers.controller("ProfileCtrl",["$scope","$stateParams","Restangular","SessionService",function(e,o,t,n){t.one("user",o.id).get().then(function(o){e.user=o.data}),e.getInclude=function(){return parseInt(o.id)!==n.user.id?"templates/proveedores/profile/_profile_footer.html":"templates/proveedores/profile/_profile_footer_mine.html"},e.edit=function(){e.transitionTo("homepage.perfil.edit")}}]),controllers.controller("MensajesCtrl",["$scope","socket","$state",function(e,o,t){o.emit("get","/conversations",function(o){e.$apply(function(){e.conversations=o})}),e.goToChat=function(e){t.transitionTo("homepage.chat",{id:e})}}]),angular.module("helpme.directives",[]).directive("helpmeNotifications",["$ionicPopover","$state",function(e,o){return{restrict:"E",scope:{messages:"="},replace:!0,template:'<button class="button button-clear button-stable" ng-click="open($event)"><i ng-class="{\'icon ion-chatbubbles\': hasMessages(), \'icon ion-chatbubble\': !hasMessages()}">{{ count }}</i></button>',link:function(t){t.count=0,t.hasMessages=function(){return t.count>0},t.$on("user.messaged",function(){console.log(t.messages),t.$apply(function(){t.count++})}),e.fromTemplateUrl("popover.html",{scope:t}).then(function(e){t.popover=e}),t.open=function(e){t.popover.show(e)},t.goToChat=function(e){_.remove(t.messages,function(o){return o.data.id==e.data.id}),t.popover.hide(),o.transitionTo("homepage.chat",{id:e.data.from.userid})}}}}]).directive("helpmeShare",["$ionicPopover","$cordovaCamera",function(e,o){return{restrict:"A",scope:{sendPicture:"&"},template:'<button class="button button-icon icon ion-share" ng-click="openPopover($event)"></button>',replace:!0,link:function(t){var n={quality:75,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.CAMERA,allowEdit:!1,encodingType:Camera.EncodingType.JPEG,saveToPhotoAlbum:!1};e.fromTemplateUrl("templates/proveedores/shareMenu.html",{scope:t}).then(function(e){t.popover=e}),t.openPopover=function(e){t.popover.show(e)},t.openCamera=function(){o.getPicture(n).then(function(e){t.popover.hide(),t.sendPicture({imageData:e})})}}}}]),angular.module("helpme.filters",[]).filter("default",function(){return function(e,o){var t="No indica";return e?e:o||t}}),angular.module("helpme",["ionic","restangular","helpme.controllers","helpme.services","helpme.directives","helpme.filters","ngCordova","igTruncate"]).run(function(e,o,t,n){e.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&StatusBar.styleDefault(),window.plugin.notification.local.onclick=function(e,t,n){alert(JSON.parse(n).from),o.$broadcast("notification.local.click",{id:e,state:t,json:JSON.parse(n)})}}),o.$on("$stateChangeStart",function(e,o){o.data.requiresLogin&&!t.authenticated&&(e.preventDefault(),n.transitionTo("login"))})}).config(function(e,o,t,n,s){t.setBaseUrl(ENDPOINT),t.setFullResponse(!0),n.setIo(io),e.state("root",{url:"/",controller:function(e){e.transitionTo("login")},data:{requiresLogin:!1}}).state("login",{url:"/login",templateUrl:"templates/login.html",controller:"LoginCtrl",data:{requiresLogin:!1}}).state("homepage",{url:"/home","abstract":!0,controller:"HomepageCtrl",templateUrl:"templates/menu.html",data:{requiresLogin:!0}}).state("homepage.proveedores",{url:"/proveedores",views:{menuContent:{templateUrl:"templates/proveedores.html",controller:"ProveedoresCtrl"}},data:{requiresLogin:!0}}).state("homepage.messages",{url:"/proveedores/messages",views:{menuContent:{templateUrl:"../templates/proveedores/mensajes.html",controller:"MessagesCtrl"}},data:{requiresLogin:!0}}).state("homepage.chat",{url:"/proveedores/chat/:id",views:{menuContent:{templateUrl:"templates/proveedores/show.html",controller:"ChatCtrl"}},data:{requiresLogin:!0}}).state("homepage.profile",{url:"/profile/:id",views:{menuContent:{templateUrl:"templates/proveedores/profile/profile.html",controller:"ProfileCtrl"}}}),o.otherwise("/"),s.interceptors.push("TokenInterceptor")}),ionic.Platform.ready(function(){window.plugin.notification.local.onclick=function(e,o,t){"com.help.upplus4.notification.message"==e&&$scope.apply(function(){$state.transitionTo("homepage.chat",{id:t.from})})}});var controllers;controllers=angular.module("helpme.controllers",[]),controllers.controller("LoginCtrl",["$scope","$state","SessionService","$ionicPopup","LoadingService",function(e,o,t,n,s){return e.loginData={},e.showBar=!1,e.login=function(e){s.show("Comprobando credenciales..."),t.login(e,function(e){s.hide(),200==e.status?o.transitionTo("homepage.proveedores"):n.alert({title:'<i class="icon ion-alert-circled"></i>  Usuario o contraseña inválida',template:"Compruebe las credenciales"})})}}]),controllers.controller("MainCtrl",function(e,o,t,n){e.messages=[],e.messageCount=0,e.user={},e.messages=[],e.total_users=0,e.incommingMessages=[],e.users=[],e.useGPS={status:!1},e.goToMessages=function(){o.transitionTo("messages")},e.$on("notification.local.click",function(t,n){"com.help.upplus4.notification.message"==n.id&&e.apply(function(){o.transitionTo("homepage.chat",{id:n.json.from})})}),e.$on("user.messaged",function(o,n){t.add({id:"com.help.upplus4.notification.message",title:"Mensaje recibido",message:n.data.from.name+": "+n.data.message,json:{from:n.data.from.userid}}).then(function(e){console.log(e)}),e.incommingMessages.push(n)}),e.goToProfile=function(){o.transitionTo("homepage.profile",{id:n.user.id})},e.$watch("useGPS.status",function(e,o){o&&console.log("activado GPS")})}),controllers.controller("HomepageCtrl",function(){}),controllers.controller("ProveedoresCtrl",["$scope","socket","$window","$ionicActionSheet","$state",function(e,o,t,n,s){e.$on("user.added",function(o,t){e.$apply(function(){e.users.push(t)})}),e.$on("user.destroyed",function(o,t){var n=_.findIndex(e.users,function(e){return e.id==t});e.$apply(function(){e.users.splice(n,1)})}),o.emit("get","/sessionuser/list",{headers:{Authorization:t.sessionStorage.token}},function(o){e.$apply(function(){e.users=o})}),e.openSheet=function(e){n.show({buttons:[{text:'<i class="icon ion-person"></i> Ver perfil'},{text:'<i class="icon ion-chatbox"></i> Enviar mensaje'}],titleText:"Acciones",buttonClicked:function(o){1==o&&s.transitionTo("homepage.chat",{id:e}),0==o&&s.transitionTo("homepage.profile",{id:e})}})}}]),controllers.controller("ChatCtrl",["$scope","$rootScope","$stateParams","socket","$cordovaLocalNotification","$window","SessionService","$ionicScrollDelegate","$ionicModal",function(e,o,t,n,s,i,r,a,c){var l=t.id;n.socket.get("/conversations/"+r.user.id+"/"+l,{headers:{Authorization:i.sessionStorage.token}},function(o){e.$apply(function(){a.$getByHandle("chat").scrollBottom(),e.messages=o})}),n.socket.get("/sessionuser/"+l,{headers:{Authorization:i.sessionStorage.token}},function(o){e.user=o}),e.send=function(o,t){e.message="",n.socket.post("/sessionuser/message/",{to:l,message:o,type:t,headers:{Authorization:i.sessionStorage.token}},function(o){e.$apply(function(){e.messages.push(o),a.$getByHandle("chat").scrollBottom()})})},e.$on("user.messaged",function(o,t){t.data.from.userid==l?e.$apply(function(){e.messages.push(t.data),a.$getByHandle("chat").scrollBottom()}):s.add({id:"com.help.upplus4.notification.message",title:"Mensaje recibido",message:t.data.from.name+": "+t.data.message,json:{to:t.data.from.userid}}).then(function(e){console.log(e)})}),e.receivePicture=function(o){e.send(o,"image")},e.openImage=function(o){e.imageTap=o,c.fromTemplateUrl("templates/proveedores/imageModal.html",{scope:e,animation:"slide-in-up"}).then(function(o){e.modal=o,e.modal.show()}),e.closeModal=function(){e.modal.hide()}}}]),controllers.controller("NotificationsCtrl",["$scope","$state","$ionicPopover",function(e,o,t){e.goToChat=function(t){o.transitionTo("homepage.chat",{id:t}),e.popover.hide()},t.fromTemplateUrl("popover.html",{scope:e}).then(function(o){e.popover=o}),e.openPopover=function(o){e.popover.show(o)}}]),controllers.controller("ProfileCtrl",["$scope","$stateParams","Restangular","SessionService",function(e,o,t,n){t.one("user",o.id).get().then(function(o){e.user=o.data}),e.getInclude=function(){return parseInt(o.id)!==n.user.id?"templates/proveedores/profile/_profile_footer.html":"templates/proveedores/profile/_profile_footer_mine.html"},e.edit=function(){e.transitionTo("homepage.perfil.edit")}}]),controllers.controller("MessagesCtrl",["$scope","socket",function(){}]),angular.module("helpme.directives",[]).directive("helpmeNotifications",["$ionicPopover","$state",function(e,o){return{restrict:"E",scope:{messages:"="},replace:!0,template:'<button class="button button-clear button-stable" ng-click="open($event)"><i ng-class="{\'icon ion-chatbubbles\': hasMessages(), \'icon ion-chatbubble\': !hasMessages()}">{{ count }}</i></button>',link:function(t){t.count=0,t.hasMessages=function(){return t.count>0},t.$on("user.messaged",function(){console.log(t.messages),t.$apply(function(){t.count++})}),e.fromTemplateUrl("popover.html",{scope:t}).then(function(e){t.popover=e}),t.open=function(e){t.popover.show(e)},t.goToChat=function(e){_.remove(t.messages,function(o){return o.data.id==e.data.id}),t.popover.hide(),o.transitionTo("homepage.chat",{id:e.data.from.userid})}}}}]).directive("helpmeShare",["$ionicPopover","$cordovaCamera",function(e,o){return{restrict:"A",scope:{sendPicture:"&"},template:'<button class="button button-icon icon ion-share" ng-click="openPopover($event)"></button>',replace:!0,link:function(t){var n={quality:75,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.CAMERA,allowEdit:!1,encodingType:Camera.EncodingType.JPEG,saveToPhotoAlbum:!1};e.fromTemplateUrl("templates/proveedores/shareMenu.html",{scope:t}).then(function(e){t.popover=e}),t.openPopover=function(e){t.popover.show(e)},t.openCamera=function(){o.getPicture(n).then(function(e){t.popover.hide(),t.sendPicture({imageData:e})})}}}}]),angular.module("helpme.filters",[]).filter("default",function(){return function(e,o){var t="No indica";return e?e:o||t}}),angular.module("starter",["ionic","starter.controllers"]).run(function(e){e.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&StatusBar.styleDefault()})}).config(function(e,o){e.state("app",{url:"/app","abstract":!0,templateUrl:"templates/menu.html",controller:"AppCtrl"}).state("app.search",{url:"/search",views:{menuContent:{templateUrl:"templates/search.html"}}}).state("app.browse",{url:"/browse",views:{menuContent:{templateUrl:"templates/browse.html"}}}).state("app.playlists",{url:"/playlists",views:{menuContent:{templateUrl:"templates/playlists.html",controller:"PlaylistsCtrl"}}}).state("app.single",{url:"/playlists/:playlistId",views:{menuContent:{templateUrl:"templates/playlist.html",controller:"PlaylistCtrl"}}}),o.otherwise("/app/playlists")}),angular.module("starter.controllers",[]).controller("AppCtrl",function(e,o,t){e.loginData={},o.fromTemplateUrl("templates/login.html",{scope:e}).then(function(o){e.modal=o}),e.closeLogin=function(){e.modal.hide()},e.login=function(){e.modal.show()},e.doLogin=function(){console.log("Doing login",e.loginData),t(function(){e.closeLogin()},1e3)}}).controller("PlaylistsCtrl",function(e){e.playlists=[{title:"Reggae",id:1},{title:"Rock nacional",id:2},{title:"Dubstep",id:3},{title:"Indie",id:4},{title:"Rap",id:5},{title:"Cowbell",id:6}]}).controller("PlaylistCtrl",function(){}),angular.module("helpme.services",[]).factory("SessionService",function(e,o){return{authenticated:!1,username:null,id:null,user:{},token:null,login:function(t,n){var s=this;e.all("user").all("login").post(t).then(function(e){return o.sessionStorage.token=s.token=e.data.token,s.authenticated=!0,s.user=e.data,n(e)},function(e){return n(e)})}}}).provider("socket",function(){this.setIo=function(e){this.io=e},this.$get=["$rootScope","SessionService",function(e,o){return new SocketIO(this.io,e,o)}]}).factory("TokenInterceptor",function(e,o){return{request:function(e){return e.headers=e.headers||{},o.sessionStorage.token&&(e.headers.Authorization=o.sessionStorage.token),e},response:function(o){return o||e.when(o)}}}).factory("LoadingService",function(e){return{show:function(o){e.show({template:'<i class="icon ion-loading-c"></i> '+o})},hide:function(){e.hide()}}}),angular.module("helpme.services",[]).factory("SessionService",function(e,o){return{authenticated:!1,user:{},token:null,login:function(t,n){var s=this;e.all("user").all("login").post(t).then(function(e){return o.sessionStorage.token=s.token=e.data.token,s.authenticated=!0,s.user=e.data,n(e)},function(e){return n(e)})},logout:function(){delete o.sessionStorage.token,self.authenticated=!1,self.user={}}}}).provider("socket",function(){this.setIo=function(e){this.io=e},this.$get=["$rootScope","SessionService",function(e,o){return new SocketIO(this.io,e,o)}]}).factory("TokenInterceptor",function(e,o){return{request:function(e){return e.headers=e.headers||{},o.sessionStorage.token&&(e.headers.Authorization=o.sessionStorage.token),e},response:function(o){return o||e.when(o)}}}).factory("LoadingService",function(e){return{show:function(o){e.show({template:'<i class="icon ion-loading-c"></i> '+o})},hide:function(){e.hide()}}}).factory("Conversations",["Restangular",function(){}]),angular.module("helpme.services",[]).factory("SessionService",function(e,o){return{authenticated:!1,user:{},token:null,login:function(t,n){var s=this;e.all("user").all("login").post(t).then(function(e){return o.sessionStorage.token=s.token=e.data.token,s.authenticated=!0,s.user=e.data,n(e)},function(e){return n(e)})},logout:function(){delete o.sessionStorage.token,self.authenticated=!1,self.user={}}}}).provider("socket",function(){this.setIo=function(e){this.io=e},this.$get=["$rootScope","SessionService",function(e,o){return new SocketIO(this.io,e,o)}]}).factory("TokenInterceptor",function(e,o){return{request:function(e){return e.headers=e.headers||{},o.sessionStorage.token&&(e.headers.Authorization=o.sessionStorage.token),e},response:function(o){return o||e.when(o)}}}).factory("LoadingService",function(e){return{show:function(o){e.show({template:'<i class="icon ion-loading-c"></i> '+o})},hide:function(){e.hide()}}}).factory("Conversations",["Restangular",function(){}]),angular.module("helpme.services",[]).factory("SessionService",function(e,o){return{authenticated:!1,user:{},token:null,login:function(t,n){var s=this;e.all("user").all("login").post(t).then(function(e){return o.sessionStorage.token=s.token=e.data.token,s.authenticated=!0,s.user=e.data,n(e)},function(e){return n(e)})},logout:function(){delete o.sessionStorage.token,self.authenticated=!1,self.user={}}}}).provider("socket",function(){this.setIo=function(e){this.io=e},this.$get=["$rootScope","SessionService",function(e,o){return new SocketIO(this.io,e,o)}]}).factory("TokenInterceptor",function(e,o){return{request:function(e){return e.headers=e.headers||{},o.sessionStorage.token&&(e.headers.Authorization=o.sessionStorage.token),e},response:function(o){return o||e.when(o)}}}).factory("LoadingService",function(e){return{show:function(o){e.show({template:'<i class="icon ion-loading-c"></i> '+o})},hide:function(){e.hide()}}}).factory("Conversations",["Restangular",function(){}]),angular.module("helpme.services",[]).factory("SessionService",function(e,o){return{authenticated:!1,user:{},token:null,login:function(t,n){var s=this;e.all("user").all("login").post(t).then(function(e){return o.sessionStorage.token=s.token=e.data.token,s.authenticated=!0,s.user=e.data,n(e)},function(e){return n(e)})},logout:function(){delete o.sessionStorage.token,self.authenticated=!1,self.user={}}}}).provider("socket",function(){this.setIo=function(e){this.io=e},this.$get=["$rootScope","SessionService",function(e,o){return new SocketIO(this.io,e,o)}]}).factory("TokenInterceptor",function(e,o){return{request:function(e){return e.headers=e.headers||{},o.sessionStorage.token&&(e.headers.Authorization=o.sessionStorage.token),e},response:function(o){return o||e.when(o)}}}).factory("LoadingService",function(e){return{show:function(o){e.show({template:'<i class="icon ion-loading-c"></i> '+o})},hide:function(){e.hide()}}}).factory("Conversations",["Restangular",function(){}]);
function SocketIO(e,s,t){this.io=e,this.socket=null,this.users=[],this.emit=function(e,s,n,o){var i=this;"undefined"==typeof o&&(o=null),"function"==typeof n&&(o=n,n={}),null==this.socket?(this.socket=this.io.connect(ENDPOINT,{query:"token="+t.token}),this.socket.on("connect",function(){i.bindEvents(),i.socket[e](s,n,function(e){return o&&o(e)})})):this.socket[e](s,n,function(e){return o&&o(e)})},this.bindEvents=function(){var e=this;e.socket.on("sessionuser",function(t){var n;switch(t.verb){case"updated":t.previous&&t.previous.socketId==e.socket.socket.sessionid?(console.log("llega, deslogueando"),s.$broadcast("user.session.close")):(n=_.findIndex(e.users,{userid:t.id}),e.users[n]=_.merge(e.users[n],t.data),s.$broadcast(t.data.online===!0?"user.logged_in":"user.destroyed"));break;case"created":_.findIndex(e.users,{userid:t.id})||(e.users.push(t.data),s.$broadcast("user.added",t.data));break;case"destroyed":if(t.previous&&t.previous.socketId==e.socket.socket.sessionid)s.$broadcast("user.session.close");else{var o=_.findIndex(e.users,function(e){return e.userid==t.id});e.users[o].online=!1,s.$broadcast("user.destroyed",o)}break;case"messaged":s.$broadcast("user.messaged",t)}}),e.socket.on("gps",function(e){switch(e.verb){case"created":s.$broadcast("gps.received",e);break;case"updated":s.$broadcast("gps.received",e)}}),e.socket.on("conversation",function(e){switch(e.verb){case"updated":s.$broadcast("conversation.updated",e.data)}})}}angular.module("helpme.services",[]).factory("SessionService",function(e,s){return{authenticated:!1,user:{},token:null,login:function(t,n){var o=this;e.all("user").all("login").post(t).then(function(e){return s.sessionStorage.token=o.token=e.data.token,o.authenticated=!0,o.user=e.data,n(e)},function(e){return n(e)})},logout:function(){delete s.sessionStorage.token,self.authenticated=!1,self.user={}}}}).provider("socket",function(){this.setIo=function(e){this.io=e},this.$get=["$rootScope","SessionService",function(e,s){return new SocketIO(this.io,e,s)}]}).factory("TokenInterceptor",function(e,s){return{request:function(e){return e.headers=e.headers||{},s.sessionStorage.token&&(e.headers.Authorization=s.sessionStorage.token),e},response:function(s){return s||e.when(s)}}}).factory("LoadingService",function(e){return{show:function(s){e.show({template:'<i class="icon ion-loading-c"></i> '+s})},hide:function(){e.hide()}}}).factory("Conversations",["Restangular",function(){}]);